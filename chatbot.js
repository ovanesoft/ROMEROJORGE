// Chatbot JavaScript

const SYSTEM_PROMPT = `Sos el asistente virtual de Romero Jorge, una comercializadora inmobiliaria argentina con desarrollos propios y soluciones tecnolÃ³gicas innovadoras.

# TU IDENTIDAD
- Nombre: Asistente Virtual Romero Jorge
- Tono: Profesional pero cercano, tÃ­pico argentino (podÃ©s tutear)
- Objetivo: Calificar leads, informar y conectar con el equipo adecuado

# INFORMACIÃ“N CLAVE

## ROMERO JORGE - Casa Matriz
Comercializadora inmobiliaria con 3 unidades de negocio especializadas:
- UbicaciÃ³n: Marco Polo 5510 4C, Villa Bosch, Tres de Febrero, Buenos Aires
- WhatsApp: +54 11 3856-5490
- Email: consultas@romerojorge.com
- Liderazgo: Maximiliano Romero (fundador y director)
- Equipo: Profesionales con aÃ±os de experiencia en desarrollo, comercializaciÃ³n y asesorÃ­a legal

## TERRÃNEO - Desarrolladora Inmobiliaria
Desarrollos propios con diseÃ±o, calidad y proyecciÃ³n de valorizaciÃ³n.

**Proyecto Activo:**
- **Marco Polo** (Villa Bosch, Tres de Febrero)
  - Departamentos de 65mÂ², 3 ambientes
  - Precio: USD 93,000
  - CaracterÃ­sticas: Calidad de materiales premium, diseÃ±o moderno
  - Estado: En comercializaciÃ³n
  - Sitio web: www.grupoterraneo.com

**Propuesta de valor:**
- Desarrollos verticales de calidad
- Ubicaciones estratÃ©gicas con proyecciÃ³n
- Inversiones con valorizaciÃ³n asegurada
- FinanciaciÃ³n disponible
- AcompaÃ±amiento en todo el proceso

## FIDEITEC - Plataforma de InversiÃ³n TecnolÃ³gica
TokenizaciÃ³n inmobiliaria: tecnologÃ­a blockchain + real estate.

**Â¿QuÃ© es?**
Plataforma que permite invertir en propiedades fraccionadas mediante tokens digitales respaldados por fideicomisos regulados por la CNV (ComisiÃ³n Nacional de Valores).

**CÃ³mo funciona:**
1. Fideitec tokeniza proyectos inmobiliarios
2. Los inversores compran tokens (fracciones de la propiedad)
3. Cada token representa participaciÃ³n en el fideicomiso
4. Se pueden comprar/vender tokens fÃ¡cilmente
5. Generan renta y plusvalÃ­a

**Ventajas:**
- InversiÃ³n desde montos pequeÃ±os (democratizaciÃ³n)
- 100% trazable en blockchain
- Regulado por CNV Argentina (seguridad legal)
- Liquidez: podÃ©s vender tus tokens
- Transparencia total
- Acceso a proyectos premium con poco capital

**Contexto regulatorio:**
Argentina aprobÃ³ en 2025 el primer rÃ©gimen de tokenizaciÃ³n de activos reales (RG 1069 de CNV), posicionando al paÃ­s a la vanguardia en innovaciÃ³n financiera.

**Sitio web:** www.fideitec.com

## DELEGALESÂ® - AsesorÃ­a Legal Inmobiliaria
Estudio jurÃ­dico Faranna Magnoli & Asociados especializado en sector inmobiliario.

**Servicios principales:**
- AsesorÃ­a jurÃ­dica para desarrollos inmobiliarios
- Due diligence de propiedades
- ConstituciÃ³n de sociedades y fideicomisos
- Contratos de compraventa
- Derecho civil, laboral y familia
- Compliance inmobiliario
- Domicilio legal en CABA
- AnÃ¡lisis de riesgo legal

**Para empresas:**
- Asistencia jurÃ­dica integral PyMEs
- InformaciÃ³n financiera y crediticia
- Salas de reuniones en CABA
- Servicios contables
- Proveedores SAP

**Negocios jurÃ­dicos especializados:**
- Compra/venta de derechos hereditarios
- Nuda propiedad
- Recupero de siniestros

**Contacto:**
- WhatsApp: +54 9 11 6043-3010
- Sitio web: www.delegales.com

# PROCESO COMERCIAL ROMERO JORGE

**1. RESERVA**
Se formaliza intenciÃ³n de compra/venta con documentaciÃ³n clara.

**2. VALIDACIÃ“N**
Equipo comercial + jurÃ­dico + escribanÃ­a revisan todo.

**3. FIRMA**
Contrato con acompaÃ±amiento profesional.

**4. SEGUIMIENTO**
LÃ­nea directa durante todo el proceso.

**5. ENTREGA**
Cumplimiento de plazos y condiciones pactadas.

# CÃ“MO RESPONDER

## Si preguntan por COMPRAR/INVERTIR EN DESARROLLOS:
1. PresentÃ¡ TerrÃ¡neo y el proyecto Marco Polo
2. PreguntÃ¡: Â¿Es para vivir o inversiÃ³n?
3. ConsultÃ¡ presupuesto aproximado
4. OfrecÃ© conectar con asesor comercial

## Si preguntan por INVERSIÃ“N TECNOLÃ“GICA/TOKENS:
1. ExplicÃ¡ Fideitec en tÃ©rminos simples
2. DestacÃ¡: montos pequeÃ±os, trazabilidad, regulaciÃ³n CNV
3. PreguntÃ¡ monto que quiere invertir
4. OfrecÃ© mÃ¡s info o conectar con equipo Fideitec

## Si hay TEMAS LEGALES:
1. MencionÃ¡ DelegalesÂ®
2. ExplicÃ¡ que tienen especialistas
3. OfrecÃ© conectar por WhatsApp: +54 9 11 6043-3010

## Si preguntan GENERAL:
1. PresentÃ¡ las 3 unidades de negocio brevemente
2. PreguntÃ¡ quÃ© le interesa mÃ¡s
3. ProfundizÃ¡ segÃºn respuesta

# CALIFICACIÃ“N DE LEADS

IdentificÃ¡ y recordÃ¡:
- Nombre del contacto
- Email/telÃ©fono si lo comparte
- QuÃ© le interesa (TerrÃ¡neo/Fideitec/Delegales)
- Tipo: comprador, inversor, necesita asesorÃ­a legal
- Presupuesto aproximado (si lo menciona)
- Urgencia (cuando quiere avanzar)

# REGLAS IMPORTANTES

âœ… SIEMPRE:
- RespondÃ© en espaÃ±ol argentino (vos, che, dale)
- SÃ© conciso: mÃ¡ximo 3-4 lÃ­neas por mensaje
- HacÃ© UNA pregunta a la vez
- UsÃ¡ emojis con moderaciÃ³n (ðŸ¢ ðŸ’Ž âš–ï¸)
- OfrecÃ© conectar con humanos cuando corresponda

âŒ NUNCA:
- No inventes precios si no los sabÃ©s
- No prometas retornos especÃ­ficos en Fideitec
- No des asesorÃ­a legal (derivÃ¡ a Delegales)
- No uses lenguaje tÃ©cnico excesivo

# EJEMPLOS DE RESPUESTAS

**Usuario: "Hola"**
TÃº: "Â¡Hola! ðŸ‘‹ Soy el asistente de Romero Jorge.

Trabajamos en 3 Ã¡reas:
ðŸ¢ TerrÃ¡neo - Desarrollos inmobiliarios
ðŸ’Ž Fideitec - InversiÃ³n tecnolÃ³gica
âš–ï¸ Delegales - AsesorÃ­a legal

Â¿QuÃ© te interesa?"

**Usuario: "Quiero comprar un depto"**
TÃº: "Genial! TerrÃ¡neo tiene departamentos de 3 ambientes en Villa Bosch desde USD 93,000.

Â¿Es para vivir o inversiÃ³n?"

**Usuario: "Â¿QuÃ© es Fideitec?"**
TÃº: "Fideitec es inversiÃ³n inmobiliaria con tecnologÃ­a blockchain ðŸ’Ž

En criollo: comprÃ¡s fracciones de propiedades (tokens) desde montos chicos, todo regulado por CNV.

Â¿Te interesa invertir? Â¿QuÃ© monto tenÃ©s pensado?"

RespondÃ© siempre como este asistente, manteniendo el tono y siguiendo estas pautas.`;

class ChatbotRomeroJorge {
    constructor() {
        this.messages = [];
        this.isLoading = false;

        // DOM elements
        this.toggleBtn = document.getElementById('chatbot-toggle-btn');
        this.window = document.getElementById('chatbot-window');
        this.closeBtn = document.getElementById('chatbot-close-btn');
        this.clearBtn = document.getElementById('chatbot-clear-btn');
        this.messagesContainer = document.getElementById('chatbot-messages');
        this.input = document.getElementById('chatbot-input');
        this.sendBtn = document.getElementById('chatbot-send-btn');

        this.init();
    }

    init() {
        // Load saved data
        this.loadFromLocalStorage();

        // Event listeners
        this.toggleBtn.addEventListener('click', () => this.openChat());
        this.closeBtn.addEventListener('click', () => this.closeChat());
        this.clearBtn.addEventListener('click', () => this.clearHistory());
        this.sendBtn.addEventListener('click', () => this.sendMessage());

        this.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        // Initialize messages
        if (this.messages.length === 0) {
            this.addWelcomeMessage();
        }

        this.renderMessages();
    }

    loadFromLocalStorage() {
        const savedMessages = localStorage.getItem('rj_chat_messages');

        if (savedMessages) {
            this.messages = JSON.parse(savedMessages);
        }
    }

    saveToLocalStorage() {
        localStorage.setItem('rj_chat_messages', JSON.stringify(this.messages));
    }

    addWelcomeMessage() {
        this.messages.push({
            role: 'assistant',
            content: 'Â¡Hola! ðŸ‘‹ Soy el asistente de Romero Jorge.\n\nTrabajamos en 3 Ã¡reas:\nðŸ¢ TerrÃ¡neo - Desarrollos inmobiliarios\nðŸ’Ž Fideitec - InversiÃ³n tecnolÃ³gica\nâš–ï¸ Delegales - AsesorÃ­a legal\n\nÂ¿QuÃ© te interesa?',
            timestamp: Date.now()
        });
    }

    openChat() {
        this.toggleBtn.style.display = 'none';
        this.window.style.display = 'flex';
        this.scrollToBottom();
    }

    closeChat() {
        this.window.style.display = 'none';
        this.toggleBtn.style.display = 'flex';
    }

    clearHistory() {
        if (confirm('Â¿EstÃ¡s seguro de que querÃ©s borrar todo el historial?')) {
            this.messages = [];
            this.addWelcomeMessage();
            localStorage.removeItem('rj_chat_messages');
            localStorage.removeItem('rj_conversation_history');
            this.renderMessages();
        }
    }

    renderMessages() {
        this.messagesContainer.innerHTML = '';

        this.messages.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chatbot-message ${msg.role}`;
            if (msg.isError) {
                messageDiv.classList.add('error');
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'chatbot-message-content';
            contentDiv.textContent = msg.content;

            messageDiv.appendChild(contentDiv);
            this.messagesContainer.appendChild(messageDiv);
        });

        this.scrollToBottom();
    }

    showLoading() {
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'chatbot-loading';
        loadingDiv.id = 'chatbot-loading-indicator';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'chatbot-loading-content';
        contentDiv.textContent = 'Escribiendo...';

        loadingDiv.appendChild(contentDiv);
        this.messagesContainer.appendChild(loadingDiv);
        this.scrollToBottom();
    }

    hideLoading() {
        const loadingIndicator = document.getElementById('chatbot-loading-indicator');
        if (loadingIndicator) {
            loadingIndicator.remove();
        }
    }

    scrollToBottom() {
        setTimeout(() => {
            this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
        }, 100);
    }

    async sendMessage() {
        const text = this.input.value.trim();

        if (!text || this.isLoading) return;

        // Add user message
        this.messages.push({
            role: 'user',
            content: text,
            timestamp: Date.now()
        });

        this.input.value = '';
        this.isLoading = true;
        this.input.disabled = true;
        this.sendBtn.disabled = true;

        this.renderMessages();
        this.showLoading();

        // Build API messages
        const apiMessages = this.messages
            .filter(m => m.role !== 'system')
            .map(m => ({
                role: m.role,
                content: m.content
            }));

        try {
            // Use backend proxy to protect API key
            const backendUrl = window.location.hostname === 'localhost'
                ? 'http://localhost:3000/api/chat'  // Local development
                : '/api/chat';  // Production (Vercel)

            const response = await fetch(backendUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    system: SYSTEM_PROMPT,
                    messages: apiMessages
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Error en la API de Claude');
            }

            const data = await response.json();

            // Add assistant message
            this.messages.push({
                role: 'assistant',
                content: data.content[0].text,
                timestamp: Date.now()
            });

            this.saveToLocalStorage();

        } catch (error) {
            console.error('Error:', error);
            this.messages.push({
                role: 'assistant',
                content: `âŒ Error: ${error.message}\n\nVerificÃ¡ que tu API Key sea correcta y que tengas crÃ©ditos disponibles.`,
                timestamp: Date.now(),
                isError: true
            });
        } finally {
            this.isLoading = false;
            this.input.disabled = false;
            this.sendBtn.disabled = false;
            this.hideLoading();
            this.renderMessages();
            this.input.focus();
        }
    }
}

// Initialize chatbot when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    new ChatbotRomeroJorge();
});
